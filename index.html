<!-- TRYING OUT FOR VIEWMODE = PRINT MODE --> 
<!DOCTYPE html>
<html>
  <head>
    <title>Hriman's NEET Calculator</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <!-- HOME SCREEN -->
    <div id="home" class="screen">
      <div class="card">
        <h1>NEET Calculator</h1>
        <h2>What do you want to do?</h2>
        <button class="primary" onclick="startNewTest()">Calculate Marks</button>
        <button class="primary" onclick="showScreen('history')">Previous Tests</button>
        <button onclick="exportTests()">üì§ Export Tests</button>
        <button onclick="importTests()">üì• Import Tests</button>
        <p><span class="bold">PS: Please don't clear your browser data.
           <br>
           The tests are saved locally in your browser.</span></p>
        <p><span class="bold">This app is still under development. 
           <br>
           So don't freak out if you suddenly see changes.</span></p>    
        <h2>Created by Hriman</h2>   
      </div>  
    </div>

    <!-- CALCULATE SCREEN -->
    <div id="calculate" class="screen">
      <div class="card">

        <h2>Test Score Calculator</h2>
        <h3>Let's get your scores calculated!</h3>
        <div class="calc-section test-info">

            <label>
                Test Name:
                <input id="testName" type="text" placeholder="Mastery 1.1 / AITS 5">
                <span class="view-value" id="testName_view"></span>
            </label>

            <label id="editRemarkWrapper" style="display:none;">
                Edit Remark:
                <input id="editRemark" type="text"
                    placeholder="Why are you editing this test?">
            </label>

            <label>
                Test Type:
                <select id="testType">
                    <option value="major">Major (720)</option>
                    <option value="minor">Minor (400)</option>
                </select>
                <span class="view-value" id="testType_view"></span>
            </label>
        </div>

        <div class="calc-section subjects">
            <div class="subject-header">
                <span></span>
                <span>Correct</span>
                <span>Wrong</span>
            </div>

            <div class="subject-row">
                <span class="subject-name">Physics</span>

                <div class="cell">
                    <input id="phyC" type="number" min="0" max="45" required>
                    <span class="view-value" id="phyC_view"></span>
                </div>

                <div class="cell">
                    <input id="phyW" type="number" min="0" max="45" required>
                    <span class="view-value" id="phyW_view"></span>
                </div>
            </div>

            <div class="subject-row">
                <span class="subject-name">Chemistry</span>

                <div class="cell">
                    <input id="chemC" type="number" min="0" max="45" required>
                    <span class="view-value" id="chemC_view"></span>
                </div>

                <div class="cell">
                    <input id="chemW" type="number" min="0" max="45" required>
                    <span class="view-value" id="chemW_view"></span>
                </div>
            </div>

            <div class="subject-row">
                <span class="subject-name">Botany</span>

                <div class="cell">
                    <input id="botC" type="number" min="0" max="45" required>
                    <span class="view-value" id="botC_view"></span>
                </div>

                <div class="cell">
                    <input id="botW" type="number" min="0" max="45" required>
                    <span class="view-value" id="botW_view"></span>
                </div>
            </div>

            <div class="subject-row">
                <span class="subject-name">Zoology</span>

                <div class="cell">
                    <input id="zooC" type="number" min="0" max="45" required>
                    <span class="view-value" id="zooC_view"></span>
                </div>

                <div class="cell">
                    <input id="zooW" type="number" min="0" max="45" required>
                    <span class="view-value" id="zooW_view"></span>
                </div>
            </div>
        </div>

        <div class="results-section">

            <div class="results-grid">

                <div class="results-left">
                    <p id="phyResult"></p>
                    <p id="chemResult"></p>
                    <p id="botResult"></p>
                    <p id="zooResult"></p>
                </div>

                <div class="results-right">
                    <p id="totalResult"></p>
                    <p id="percentageResult"></p>
                    <p id="equivalentResult"></p>
                </div>
            </div>
            
            <div class="results-meta">
                <p id="metaInfo"></p>
                <p id="remarkDisplay" style="display:none;"></p>
            </div>
        
        </div>

        <div class="action-buttons">
            <button class="btn-primary" onclick="calculateTotal()">Get Total Marks</button>

            <button class="btn-primary" onclick="saveTest()" id="saveBtn">Save Score</button>

            <button class="btn-outline" onclick="enterEditMode()" id="editBtn">‚úèÔ∏è Edit</button>

            <button class="btn-danger" onclick="deleteCurrentTest()" id="deleteBtn">üóëÔ∏è Delete</button>

            <button class="btn-neutral" onclick="handleBack()">‚¨Ö Back</button>

            <button class="btn-neutral" onclick="showScreen('home')">üè† Home</button>
        </div>
      </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="history" class="screen active">
        <div class="card">
            <h2>Your Saved Tests</h2>
            <p>Here you can view, edit or delete your previously saved tests.</p>
            <p>Total tests saved: <span id="historyCount"></span></p>
            
            <div id="historyList"></div>
            
            <div class="action-buttons history-actions">
                <button class="btn-neutral" onclick="showScreen('home')">‚¨Ö Back</button>
                <button class="btn-neutral" onclick="showScreen('home')">üè† Home</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        let currentViewingTest = null;
        let lastScreen = "home";
        const DEV_MODE = true; // Set to true to enable auto-filled test for faster development
        let liveCalculationEnabled = false;

        function showScreen(screenId) {

            const currentActive = document.querySelector(".screen.active");

            if (currentActive) {
                lastScreen = currentActive.id;

                // Remove active to trigger fade-out
                currentActive.classList.remove("active");

                // Wait for transition to finish before switching
                setTimeout(() => {
                    document.getElementById(screenId).classList.add("active");
                }, 300);

            } else {
                document.getElementById(screenId).classList.add("active");
            }

            if (screenId === "calculate" && currentViewingTest === null) {
                enterEditMode();
            }

            if (screenId === "history") {
                loadHistory();
            }
        }

        function handleBack() {

            // If editing an existing test ‚Üí go back to its View Mode
            if (currentViewingTest !== null &&
                document.getElementById("calculate").classList.contains("active") &&
                !document.getElementById("calculate").classList.contains("view-mode")) {

                enterViewMode();
                return;
            }

            // Otherwise go to previous screen
            showScreen(lastScreen);
        }

        function readInputs() {
            const name = document.getElementById("testName").value;
            const phyC = document.getElementById("phyC").value;
            const phyW = document.getElementById("phyW").value;

            alert(
                "Test: " + name +
                "\nPhysics Correct: " + phyC +
                "\nPhysics Wrong: " + phyW
            );
        }

        function getMaxMarks() {
            const type = document.getElementById("testType").value;
            return type === "minor" ? 400 : 720;
        }

        function getMaxQuestions() {
            const type = document.getElementById("testType").value;
            return type === "minor" ? 25 : 45;
        }

        function calculatePhysics() {
            const phyC = Number(document.getElementById("phyC").value) || 0;
            const phyW = Number(document.getElementById("phyW").value) || 0;

            const maxQ = getMaxQuestions();

            if (phyC + phyW > maxQ) {
                document.getElementById("phyResult").innerText =
                    "‚ùå Physics questions cannot exceed " + maxQ;
                return;
            }

            const score = phyC * 4 - phyW;

            const subjectMax = getMaxQuestions() * 4;

            document.getElementById("phyResult").innerText =
                "Physics score: " + score + " / " + subjectMax;

        }

        function calculateChemistry() {
            const chemC = Number(document.getElementById("chemC").value) || 0;
            const chemW = Number(document.getElementById("chemW").value) || 0;

            const maxQ = getMaxQuestions();

            if (chemC + chemW > maxQ) {
                document.getElementById("chemResult").innerText =
                    "‚ùå Chemistry questions cannot exceed " + maxQ;
                return;
            }

            const score = chemC * 4 - chemW;

            const subjectMax = getMaxQuestions() * 4;

            document.getElementById("chemResult").innerText =
                "Chemistry score: " + score + " / " + subjectMax;
        }
        
        function calculateBotany() {
            const botC = Number(document.getElementById("botC").value) || 0;
            const botW = Number(document.getElementById("botW").value) || 0;

            const maxQ = getMaxQuestions();

            if (botC + botW > maxQ) {
                document.getElementById("botResult").innerText =
                    "‚ùå Botany questions cannot exceed " + maxQ;
                return;
            }

            const score = botC * 4 - botW;

            const subjectMax = getMaxQuestions() * 4;

            document.getElementById("botResult").innerText =
                "Botany score: " + score + " / " + subjectMax;
        }
        
        function calculateZoology() {
            const zooC = Number(document.getElementById("zooC").value) || 0;
            const zooW = Number(document.getElementById("zooW").value) || 0;

            const maxQ = getMaxQuestions();

            if (zooC + zooW > maxQ) {
                document.getElementById("zooResult").innerText =
                    "‚ùå Zoology questions cannot exceed " + maxQ;
                return;
            }

            const score = zooC * 4 - zooW;

            const subjectMax = getMaxQuestions() * 4;

            document.getElementById("zooResult").innerText =
                "Zoology score: " + score + " / " + subjectMax;
        }

        function calculateTotal() {
            liveCalculationEnabled = true;

            const fields = [
                "phyC","phyW",
                "chemC","chemW",
                "botC","botW",
                "zooC","zooW"
            ];

            for (let id of fields) {
                if (document.getElementById(id).value === "") {
                    document.getElementById("totalResult").innerText =
                        "‚ö†Ô∏è Please fill all fields before calculating total.";
                    return;
                }
            }

            // üîÅ Update individual subject results
            calculatePhysics();
            calculateChemistry();
            calculateBotany();
            calculateZoology();

            // üö´ Stop total calculation if any subject exceeded max questions
            const errorExists = [
                "phyResult",
                "chemResult",
                "botResult",
                "zooResult"
            ].some(id =>
                document.getElementById(id).innerText.includes("cannot exceed")
            );

            if (errorExists) {
                document.getElementById("totalResult").innerText =
                    "‚ùå Fix subject errors before calculating total.";

                document.getElementById("percentageResult").innerText = "";
                document.getElementById("equivalentResult").innerText = "";
                return;
            }

            const phyC = Number(document.getElementById("phyC").value) || 0;
            const phyW = Number(document.getElementById("phyW").value) || 0;

            const chemC = Number(document.getElementById("chemC").value) || 0;
            const chemW = Number(document.getElementById("chemW").value) || 0;

            const botC = Number(document.getElementById("botC").value) || 0;
            const botW = Number(document.getElementById("botW").value) || 0;

            const zooC = Number(document.getElementById("zooC").value) || 0;
            const zooW = Number(document.getElementById("zooW").value) || 0;

            const phyScore = phyC * 4 - phyW;
            const chemScore = chemC * 4 - chemW;
            const botScore = botC * 4 - botW;
            const zooScore = zooC * 4 - zooW;

            const total = phyScore + chemScore + botScore + zooScore;

            const maxMarks = getMaxMarks();

            document.getElementById("totalResult").innerText =
                "Total score: " + total + " / " + maxMarks;
            
            const percentage = (total / maxMarks) * 100;

            document.getElementById("percentageResult").innerText =
                "Percentage: " + percentage.toFixed(2) + "%";

            if (maxMarks === 400) {
                const equivalent720 = (total / 400) * 720;

                document.getElementById("equivalentResult").innerText =
                    "Equivalent NEET score: " + Math.round(equivalent720) + " / 720";
            } else {
                document.getElementById("equivalentResult").innerText = "";
            }
        }

        function saveTest() {
            const testName = document.getElementById("testName").value || "Untitled Test";
            const testType = document.getElementById("testType").value;
            const now = new Date().toISOString();

            const rawData = {
                phyC: Number(document.getElementById("phyC").value),
                phyW: Number(document.getElementById("phyW").value),
                chemC: Number(document.getElementById("chemC").value),
                chemW: Number(document.getElementById("chemW").value),
                botC: Number(document.getElementById("botC").value),
                botW: Number(document.getElementById("botW").value),
                zooC: Number(document.getElementById("zooC").value),
                zooW: Number(document.getElementById("zooW").value)
            };

            const logs = JSON.parse(localStorage.getItem("neetLogs")) || [];

            // üÜï NEW TEST MODE
            if (currentViewingTest === null) {
                const newTest = {
                    id: Date.now(),
                    testName,
                    testType,
                    version: 1,
                    createdAt: now,
                    updatedAt: now,
                    rawData
                };

                logs.push(newTest);
                localStorage.setItem("neetLogs", JSON.stringify(logs));

                // üëá IMPORTANT: switch to viewing this saved test
                currentViewingTest = newTest;
                enterViewMode();

                alert("‚úÖ Test saved successfully");
                return;
            }

            
            // Confirm before updating existing test
            const confirmUpdate = confirm(
                "Are you sure you want to update this test?\nThis will create a new version."
            );

            if (!confirmUpdate) return;

            // ‚úèÔ∏è EDIT MODE
            const index = logs.findIndex(
                (log) => log.id === currentViewingTest.id
            );

            if (index === -1) {
                alert("‚ùå Error: test not found");
                return;
            }

            logs[index] = {
                ...logs[index],
                testName,
                testType,
                version: logs[index].version + 1,
                updatedAt: now,
                editRemark: document.getElementById("editRemark").value || "",
                rawData
            };


            localStorage.setItem("neetLogs", JSON.stringify(logs));
            currentViewingTest = logs[index];

            alert("üîÑ Test updated successfully");
        }


        function loadHistory() {
            const list = document.getElementById("historyList");
            list.innerHTML = "";

            let logs = JSON.parse(localStorage.getItem("neetLogs")) || [];

            // Always sort by createdAt (newest first)
            logs = logs.slice().sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            document.getElementById("historyCount").innerText = logs.length;

            if (logs.length === 0) {
                list.innerText = "No saved tests yet.";
                return;
            }

            logs.forEach((log) => {
                const btn = document.createElement("button");

                const date = new Date(log.createdAt).toLocaleDateString();

                const typeLabel = log.testType === "minor" ? "Minor (400)" : "Major (720)";

                btn.innerHTML = `
                    <div class="history-title">${log.testName}</div>
                    <div class="history-meta">
                        ${typeLabel} ‚Ä¢ v${log.version} ‚Ä¢ ${date}
                    </div>
                `;

                btn.onclick = function () {
                    openSavedTest(log);
                };
                list.appendChild(btn);
            });
        }

        function openSavedTest(log) {
            currentViewingTest = log;

            document.getElementById("testName").value = log.testName;
            document.getElementById("testType").value = log.testType;
            document.getElementById("editRemark").value = log.editRemark || "";

            document.getElementById("phyC").value = log.rawData.phyC;
            document.getElementById("phyW").value = log.rawData.phyW;

            document.getElementById("chemC").value = log.rawData.chemC;
            document.getElementById("chemW").value = log.rawData.chemW;

            document.getElementById("botC").value = log.rawData.botC;
            document.getElementById("botW").value = log.rawData.botW;

            document.getElementById("zooC").value = log.rawData.zooC;
            document.getElementById("zooW").value = log.rawData.zooW;

            showScreen("calculate");

            calculateTotal();

            const created = new Date(log.createdAt).toLocaleString();
            const updated = new Date(log.updatedAt).toLocaleString();

            document.getElementById("metaInfo").innerText =
                "Saved: " + created +
                " | Updated: " + updated +
                " | v" + log.version;
            
            // Show remark in VIEW MODE
            if (log.editRemark) {
                document.getElementById("remarkDisplay").innerText =
                    "Remark: " + log.editRemark;
                document.getElementById("remarkDisplay").style.display = "block";
            } else {
                document.getElementById("remarkDisplay").style.display = "none";
            }

            // üîÅ Mark that we are editing an existing test
            document.querySelector(
                "button[onclick='saveTest()']"
            ).innerText = "Update Score";
            enterViewMode();
        }

        function startNewTest() {
            liveCalculationEnabled = false;
            
            currentViewingTest = null;
            resetCalculateScreen();
            showScreen("calculate");
            if (DEV_MODE) {
                document.getElementById("testName").value = "Dev Test";
                document.getElementById("testType").value = "minor";

                document.getElementById("phyC").value = 20;
                document.getElementById("phyW").value = 5;

                document.getElementById("chemC").value = 22;
                document.getElementById("chemW").value = 3;

                document.getElementById("botC").value = 18;
                document.getElementById("botW").value = 3;

                document.getElementById("zooC").value = 22;
                document.getElementById("zooW").value = 2;

                calculateTotal();
            }
        }

        function resetCalculateScreen() {
            liveCalculationEnabled = false;

            document.getElementById("remarkDisplay").style.display = "none";

            // Clear inputs
            document.querySelectorAll("#calculate input")
                .forEach(el => {
                    el.value = "";
                    el.disabled = false;
                });

            // Reset dropdown
            document.getElementById("testType").value = "major";

            // Clear text outputs
            [
                "phyResult","chemResult","botResult","zooResult",
                "totalResult","percentageResult","equivalentResult","metaInfo"
            ].forEach(id => {
                document.getElementById(id).innerText = "";
            });

            // Force EDIT MODE visuals
            enterEditMode();

            document.getElementById("editRemark").value = "";
        }

        function enterViewMode() {
            const calc = document.getElementById("calculate");
            calc.classList.add("mode-transition");
            setTimeout(() => calc.classList.remove("mode-transition"), 200);
            
            // Activate report mode
            document.getElementById("calculate").classList.add("view-mode");

            // Copy input values into view spans
            [
                "phyC","phyW",
                "chemC","chemW",
                "botC","botW",
                "zooC","zooW"
            ].forEach(id => {
                // Copy Test Name
                document.getElementById("testName_view").innerText =
                    document.getElementById("testName").value;

                // Copy Test Type (display text, not value)
                const typeSelect = document.getElementById("testType");
                document.getElementById("testType_view").innerText =
                    typeSelect.options[typeSelect.selectedIndex].text;
                const input = document.getElementById(id);
                const span = document.getElementById(id + "_view");
                if (span) span.innerText = input.value;
            });
            
            // Lock inputs
            document.querySelectorAll("#calculate input, #calculate select")
                .forEach(el => el.disabled = true);

            // Hide calculate + save/update buttons
            document.getElementById("saveBtn").style.display = "none";
            document.querySelector(
                "button[onclick='calculateTotal()']"
            ).style.display = "none";


            // Show view-mode buttons
            document.getElementById("editBtn").style.display = "inline-block";
            document.getElementById("deleteBtn").style.display = "inline-block";
        }

        function enterEditMode() {
            const calc = document.getElementById("calculate");
            calc.classList.add("mode-transition");
            setTimeout(() => calc.classList.remove("mode-transition"), 200);

            // Remove report mode
            document.getElementById("calculate").classList.remove("view-mode");

            // Unlock inputs
            document.querySelectorAll("#calculate input, #calculate select")
                .forEach(el => el.disabled = false);

            // Show calculate + save/update buttons
            document.getElementById("saveBtn").style.display = "inline-block";
            document.querySelector(
                "button[onclick='calculateTotal()']"
            ).style.display = "inline-block";

            // Hide view-mode buttons
            document.getElementById("editBtn").style.display = "none";
            document.getElementById("deleteBtn").style.display = "none";

            // Set correct button label
            if (currentViewingTest === null) {
                document.getElementById("saveBtn").innerText = "Save Score";
            } else {
                document.getElementById("saveBtn").innerText = "Update Score";
            }
            
            // Show remark input only when editing existing test
            if (currentViewingTest !== null) {
                document.getElementById("editRemarkWrapper").style.display = "block";
            } else {
                document.getElementById("editRemarkWrapper").style.display = "none";
            }

            document.getElementById("remarkDisplay").style.display = "none";
        }

        function deleteCurrentTest() {
            if (!currentViewingTest) {
                alert("‚ùå No test selected to delete.");
                return;
            }

            const confirmDelete = confirm(
                `Delete "${currentViewingTest.testName}"?\nThis cannot be undone.`
            );

            if (!confirmDelete) return;

            const logs = JSON.parse(localStorage.getItem("neetLogs")) || [];

            const updatedLogs = logs.filter(
                log => log.id !== currentViewingTest.id
            );

            localStorage.setItem("neetLogs", JSON.stringify(updatedLogs));

            currentViewingTest = null;

            resetCalculateScreen();
            showScreen("history");

            alert("üóëÔ∏è Test deleted");
        }

        function exportTests() {
            const data = localStorage.getItem("neetLogs");

            if (!data) {
                alert("No tests to export.");
                return;
            }

            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "neet-tests-backup.json";
            a.click();

            URL.revokeObjectURL(url);
        }

        function importTests() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "application/json";

            input.onchange = function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function () {
                    try {
                        JSON.parse(reader.result); // validate JSON
                        const confirmImport = confirm(
                            "This will REPLACE all existing tests.\nContinue?"
                        );
                        if (!confirmImport) return;

                        localStorage.setItem("neetLogs", reader.result);
                        alert("‚úÖ Tests imported successfully");
                        showScreen("history");
                    } catch {
                        alert("‚ùå Invalid file");
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }
        
        // üîÑ Live calculation on input change
        document.querySelectorAll(
            "#phyC, #phyW, #chemC, #chemW, #botC, #botW, #zooC, #zooW, #testType"
        ).forEach(input => {
            input.addEventListener("input", function () {

                // Enable auto-update if:
                // 1. Editing existing test
                // 2. OR button has been clicked once in new test
                if (currentViewingTest === null && !liveCalculationEnabled) return;

                const fields = [
                    "phyC","phyW",
                    "chemC","chemW",
                    "botC","botW",
                    "zooC","zooW"
                ];

                const allFilled = fields.every(id =>
                    document.getElementById(id).value !== ""
                );

                if (allFilled) {
                    calculateTotal();
                }
            });

        });

        if (DEV_MODE) {
            window.addEventListener("load", function () {
                showScreen("history");
            });
        }

    </script>
  </body>
</html>